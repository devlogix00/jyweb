<!DOCTYPE html>
<html lang=en>
    <head>
        <meta charset="utf-8" />
        <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
        <link rel="icon" type="image/png" href="../assets/img/favicon.png">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>
          BookMe
        </title>
        <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
        <!--     Fonts and icons     -->
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
        <!-- CSS Files -->
        <link href="./css/material-kit.css"  rel="stylesheet" />
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <script src="./js/core/jquery.min.js" type="text/javascript"></script>
        <script src="./js/core/popper.min.js" type="text/javascript"></script>
        <script src="./js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
        <script src="./js/plugins/moment.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script async defer src="https://buttons.github.io/buttons.js"></script>
      </head>
      <body class="login-page sidebar-collapse">
        <nav class="navbar navbar-color-on-scroll navbar-transparent    fixed-top  navbar-expand-lg " color-on-scroll="100" id="sectionsNav">
          <div class="container">
            <div class="navbar-translate">
              <a class="navbar-brand" href="./home.html">BookMe</a>
            </div>
            <div>
              <form style="padding-top: 1em;">
                <input id="status" type="text" placeholder="status"/>
                <button onclick="submitStatus()" class="btn btn-white btn-fill btn-round">Update</button>
              </form>
            </div>
          </div>
        </nav>
        <div class="page-header header-filter">
          <div class="container">
            <div class="row">
                <div class="widget-content">
                    <form id="image-form" action="/host" method="POST">
                        <input id="type" type="text" placeholder="room, car, tour" onblur="getType()"/>
                        <label>Listing Type:</label>
                        <div id="tourForm" style="display: none;">
                          <div class="form-group">
                            <label for="from" class="col-xs-2 control-label"
                              ><i class="far fa-dot-circle"></i
                            ></label>
                            <div class="col-xs-4">
                              <input
                                type="text"
                                id="origin"
                                placeholder="Origin"
                                class="form-control"
                                
                              />
                            </div>
                          </div>
                          <div class="form-group">
                            <label for="to" class="col-xs-2 control-label"
                              ><i class="fas fa-map-marker-alt"></i
                            ></label>
                            <div class="col-xs-4">
                              <input
                                type="text"
                                id="destination"
                                placeholder="Destination"
                                class="form-control"
                                
                              />
                            </div>
                          </div>
                          <div class="col-xs-offset-2 col-xs-10">
                            <button id="calc" class="btn btn-success btn-lg " onclick="calcDist();">
                              <i class="fa fa-arrow-circle-o-right" aria-hidden="true"></i>
                            </button>
                          </div>                          
                          <div class="container-fluid">
                            <div id="map"></div>
                            <div id="mapOutput"></div>
                          </div>
                        </div>
                        <div id="rcForm" style="display: none;">
                          <div class="form-group">
                            <label for="from" class="col-xs-2 control-label"
                              ><i class="far fa-dot-circle"></i
                            ></label>
                            <div class="col-xs-offset-2 col-xs-10">
                              <button id="calcRC" class="btn btn-success btn-lg ">
                                Add Location
                              </button>
                              <p>* Please make sure you are at the exact location of the listing. *</p>
                            </div> 
                          </div>                         
                        </div>
                        <input id="name" type="text" placeholder="listing name" onblur="getName()"/>
                        <label>Name of Listing</label>
                        <input id="price" type="number" placeholder="0.00" onblur="getPrice()"/>
                        <label>Price: </label>
                        <div id="checkin" style="display: none;">
                          <input id='checkin-input' type="text" placeholder="Check-In Details" onblur="getDetails()"/>
                          <label>Check-In: </label>
                          <p>* Please provide detailed information for your checkin process. This might inlude door codes, etc.*</p>
                        </div>
                        <div>
                          <form id="image-form" action="/upload_files" >
                            <input id="mediaCapture" type="file" accept="image/*" capture="camera">
                            <button id="submitImage" title="Add an image" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--amber-400 mdl-color-text--white">
                              <i class="material-icons">image</i>
                            </button>
                          </form>
                          <!-- <form enctype="multipart/form-data">
                            <input id="mediaCapture" type="file" accept="image/*" capture="camera" onblur="getImage()">
                          </form> -->
                            
                        </div>
                        <div style="display: flex; justify-content: center;">
                            <button  id="submitListing" class="btn btn-white btn-fill btn-round">Submit</button>
                        </div>
                     </form> 

                </div>
             
                <div id="listings" style="display: flex; flex-direction: row; overflow: auto;"></div>
                
                
            </div>
           
          </div>
          <footer class="footer">
            <div class="container">
              <!-- <div class="copyright float-right">
                &copy;
                <script>
                  document.write(new Date().getFullYear())
                </script>, made with <i class="material-icons" style="color: red;">favorite</i> by
                <a href="https://www.creative-tim.com" target="_blank">Maame Nyarko</a>
              </div> -->
            </div>
          </footer>
        </div>
        <script>
         
           
       </script>
        <!--   Core JS Files   -->
        <script src="./js/core/jquery.min.js" type="text/javascript"></script>
        <script src="./js/core/popper.min.js" type="text/javascript"></script>
        <script src="./js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
        <script src="./js/plugins/moment.min.js"></script>
        <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
        <script src="./js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
        <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
        <script src="./js/plugins/nouislider.min.js" type="text/javascript"></script>
        <!-- <script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyAkpJhu166GoiLCkiRzVYLZdb-5DvYGuss&callback=initMap"></script> -->
        <!-- <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAmEt3SHmnkBXHOc3YODYPNQrYIIeEjKNg&libraries=places&callback=initMap"></script> -->
        <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
        <script src="./js/plugins/bootstrap-tagsinput.js"></script>
        <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
        <script src="./js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
        <!--	Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
        <script src="./js/plugins/jasny-bootstrap.min.js" type="text/javascript"></script>
        <!--	Plugin for Small Gallery in Product Page -->
        <script src="./js/plugins/jquery.flexisel.js" type="text/javascript"></script>
        <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
        <script src="./js/material-kit.js?v=2.2.0" type="text/javascript"></script>
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
        <script>
          let listing = {
                listingType: '',
                listingName: '',
                listingPrice: '',
                listingImg: ''
            }

           

            function getType(){
                let type = document.getElementById('type').value;
                listing.listingType = type;
                let tForm = document.getElementById('tourForm');
                let rcForm = document.getElementById('rcForm');
                if(type == 'tour'){
                  tForm.style.display = 'block';
                } else if(type == 'room'){
                  tForm.style.display = 'none';
                  document.getElementById('checkin').style.display = 'block';
                  rcForm.style.display = 'block';
                }
                 else {
                  tForm.style.display = 'none';
                  rcForm.style.display = 'block';
                }
            }
            function getName(){
                let name = document.getElementById('name').value;
                listing.listingName = name;
            }
            function getPrice(){
                let price = document.getElementById('price').value;
                listing.listingPrice = price;
            }
            function getImage(){
                let image = document.getElementById('mediaCapture').value;
                listing.listingImg = image;
            }
            function getDetails(){
                let details = document.getElementById('checkin-input').value;
                listing.checkin = details;
            }
            function postListing(){
                localStorage.setItem('newListing', JSON.stringify(listing));
            }
  
            var geocoder;
            var map;
            var rcPosition;
            var autocomplete3;
            var address3;
            

          function initMap(){
             // Set map options
             let LatLng = {lat: 8.090440925828062, lng: -1.6977176080814078};
             let mapOptions = {
               center: LatLng,
               zoom: 7
             };

             map = new google.maps.Map(document.getElementById("map"), mapOptions);
             
             let directionsService = new google.maps.DirectionsService();
             let directionsDisplay = new google.maps.DirectionsRenderer();
             directionsDisplay.setMap();

             var input1 = document.getElementById('origin');
             var autocomplete1 = new google.maps.places.Autocomplete(input1);

             var input2 = document.getElementById("destination");
             var autocomplete2 = new google.maps.places.Autocomplete(input2);
           
            
           }

           document.getElementById('calc').addEventListener('click', e => {
             e.preventDefault();
           });

           document.getElementById('calcRC').addEventListener('click', e => {
             e.preventDefault();
             if(navigator.geolocation){
                 navigator.geolocation.getCurrentPosition(
                   (position) => {
                     const pos = {
                       lat: position.coords.latitude,
                       lng: position.coords.longitude
                     };
                
                             
                     listing.location = pos;
                    // console.log(listing.location);

                 
                   }
                 );
               }
           });

           function calcDist(){
            let orig;
            let dest;
          
              var address1 = document.getElementById('origin').value;
              geocoder = new google.maps.Geocoder();
              geocoder.geocode({'address': address1}, function(results, status){
              if(status == 'OK'){
                //map.setCenter(results[0].geometry.location);
                var marker = new google.maps.Marker({
                  map: map,
                  position: results[0].geometry.location
                });
                orig = results[0].geometry.location;
                let origStrng = results[0].geometry.location.toString();
                listing.originCoord = origStrng;
                var address2 = document.getElementById('destination').value;
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({'address': address2}, function(results, status){
                  if(status == 'OK'){
                    var marker = new google.maps.Marker({
                      map: map,
                      position: results[0].geometry.location
                    });
                    dest = results[0].geometry.location;
                    let destStrng = results[0].geometry.location.toString();
                    listing.destinationCoord = destStrng;

                
                  let directionsService = new google.maps.DirectionsService();
                  let directionsDisplay = new google.maps.DirectionsRenderer();

                  var request = {
                    origin: orig,
                    destination: dest,
                    travelMode: google.maps.TravelMode.DRIVING, //WALKING, BYCYCLING, TRANSIT
                    unitSystem: google.maps.UnitSystem.IMPERIAL
                  }
                  directionsService.route(request, function(result, status){
                    if(status == google.maps.DirectionsStatus.OK){
                      directionsDisplay.setDirections(result);
                    } else {
                      directionsDisplay.setDirections({routes: []});
                      map.setCenter(mapCenter.center);
                      alert('Oops, something went wrong!');
                    }
                  });
                  
                  const output = document.querySelector('#mapOutput');
                  /**
                   * Pass the created request to the route method
                   */
                  directionsService.route(request, function (result, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                     
                      output.innerHTML = "<p>From:" + document.getElementById("origin").value + "</br>" +"To: " + document.getElementById("destination").value +
                      "</br>"+"Driving distance <i class='fas fa-road'></i> : " +
                        result.routes[0].legs[0].distance.text +"</br>"+
                        " Duration <i class='fas fa-clock'></i> : " +
                        result.routes[0].legs[0].duration.text + ".</p>";
      
                    directionsDisplay.setDirections(result);
                    } else {
              
                    directionsDisplay.setDirections({ routes: [] });
              
                    //map.setCenter(LatLng);

                    output.innerHTML = "<div class='alert-danger'><i class='fas fa-exclamation-triangle'></i> Could not retrieve driving distance.</div>";
                  }
                });
                  } else {
                    alert(status);
                  }
                });
              } else {
                alert(status);
              }
            });
           }

            
        </script>
        <script type="module">
          // Import the functions you need from the SDKs you need
          import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
          import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
          import { getAuth, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-auth.js";
          import { getDatabase, update, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js";
          import { ref as sRef, getStorage, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-storage.js";
          import { addDoc, collection, getFirestore, Timestamp, orderBy, limit, onSnapshot, query, serverTimestamp, setDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore.js";
          // TODO: Add SDKs for Firebase products that you want to use
          // https://firebase.google.com/docs/web/setup#available-libraries
        
          // Your web app's Firebase configuration
          // For Firebase JS SDK v7.20.0 and later, measurementId is optional
          const firebaseConfig = {
            apiKey: "AIzaSyAN-hSy8cWKUKJS4SxjNcN9lrmvZPTy430",
            authDomain: "booking-app-6750f.firebaseapp.com",
            databaseURL: "https://booking-app-6750f-default-rtdb.firebaseio.com",
            projectId: "booking-app-6750f",
            storageBucket: "booking-app-6750f.appspot.com",
            messagingSenderId: "687482685582",
            appId: "1:687482685582:web:a91f903ce5133c4f5aa1df",
            measurementId: "G-0WDDDKD9ZL"
          };
        
          // Initialize Firebase
          const app = initializeApp(firebaseConfig);
          const analytics = getAnalytics(app);
          const auth = getAuth();
          const db = getDatabase();
          const storage = getStorage();
          const database = getFirestore();
          // const listingDb = collection(database, 'listings');

          onAuthStateChanged(auth, (user) => {
            if (user) {
              // User is signed in 
              let userName = user.displayName;
              let userId = user.uid;
              let updates = {};

              function submitStatus(){
                let status = document.getElementById('status').value;
            
                updates['hosts/hostAccount/'+userId+'/status'] = status;
                update(ref(db), updates);
              }

              let mediaCaptureElement = document.getElementById('mediaCapture');
              let imageButtonElement = document.getElementById('submitImage');
              let imageFormElement = document.getElementById('image-form');

              imageButtonElement.addEventListener('click', function (e) {
                e.preventDefault();
                mediaCaptureElement.click();
              });

              mediaCaptureElement.addEventListener('change', onMediaFileSelected);
              function onMediaFileSelected(e){
                e.preventDefault();
                let file = e.target.files[0];
                //imageFormElement.reset();
                if(!file.type.match('image.*')){
                  let data = {
                    message: 'You can only share images',
                    timeout: 2000
                  };
                  return;
                }
                saveImage(file);
              }

              async function saveImage(file){
                const storageRef = sRef(storage, 'images/'+ file.name);
                const uploadTask = uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed', 
                  (snapshot) => {
                    // Observe state change events such as progress, pause, and resume
                    // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    
                    switch (snapshot.state) {
                    case 'paused':
                        
                        break;
                    case 'running':
                        
                        break;
                    }
                  },
                  (error) => {
                    // Handle unsuccessful uploads
                  },
                  () => {
                    getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                      listing.listingImg = downloadURL;
                    })
                  }
                )
                // const formData = new FormData();
                // formData.append("file", file);
                // fetch("https://www.buorgoldengreenresorts.homes/upload_files", {
                //   method: 'POST',
                //   body: formData
                // })
                // .then((res) => console.log(res))
                // .then((err) => ("Error occured ", err));
              }
              function generateId(length) {
                var result           = '';
                var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                var charactersLength = characters.length;
                for ( var i = 0; i < length; i++ ) {
                  result += characters.charAt(Math.floor(Math.random() * 
                  charactersLength));
                }
                    return result;
              }

              listing.itemId = generateId(24);

              document.getElementById('submitListing').addEventListener('click', e => {
                e.preventDefault();
                //let newListing = JSON.parse(localStorage.getItem('newListing'));
                let type = document.getElementById('type').value;
                listing.listingType = type;

                 if(listing.listingType == 'tour'){
            
                  let origin = document.getElementById('origin').value;
                  listing.originName = origin;

                  let destination = document.getElementById('destination').value;
                  listing.destinationName = destination;

                  let name = document.getElementById('name').value;
                  listing.listingName = name;

                  let price = document.getElementById('price').value;
                  listing.listingPrice = price;

                  listing.host = userId;

                  updates['hosts/hostAccount/'+userId+'/listing'] = listing;
                  updates['hosts/hostAccount/'+userId+'/tours/'+listing.listingName] = listing;
                  updates['listing/'] = listing;
                  updates['tours/'+listing.listingName] = listing;
                  updates['tours/listing'] = listing;
                  update(ref(db), updates);
                  const listingRef = ref(db, 'listings/listings/');
                  onValue(listingRef, (snapshot) => {
                    const data = snapshot.val();
                    if(data != null){
                      let dataLen = data.length;
                      updates['listings/listings/'+dataLen] = listing;
                      update(ref(db), updates);
                    } else {
                      updates['listings/listings/0'] = listing;
                      update(ref(db), updates);
                    }
                  },{
                        onlyOnce: true
                    });
                 
                 } else {
                  document.getElementById('calcRC').addEventListener('click', function(){
                    
                    updates['rooms/'+listing.listingName+'/location'] = listing.location;
                    updates['rooms/listing/location'] = listing.location;
                    updates['cars/'+listing.listingName+'/location'] = listing.location;
                    updates['cars/listing/location'] = listing.location;
                    update(ref(db), updates);
                    const listingRef = ref(db, 'listings/listings/');
                    onValue(listingRef, (snapshot) => {
                      const data = snapshot.val();
                      if(data != null){
                        let dataLen = data.length;
                        updates['listings/listings/'+dataLen] = listing;
                        update(ref(db), updates);
                      } else {
                        updates['listings/listings/0'] = listing;
                        update(ref(db), updates);
                      }
                    },{
                        onlyOnce: true
                    });
                  });
                  
                  let name = document.getElementById('name').value;
                  listing.listingName = name;
                  let price = document.getElementById('price').value;
                  listing.listingPrice = price;
                  listing.host = userId;
                  updates['hosts/hostAccount/'+userId+'/listing'] = listing;
                  updates['hosts/hostAccount/'+userId+'/rooms/'+listing.listingName] = listing;
                  updates['listing/'] = listing;
                  update(ref(db), updates);
                  if(listing.listingType == 'room'){
                    updates['rooms/'+listing.listingName] = listing;
                    updates['hosts/hostAccount/'+userId+'/rooms/'+listing.listingName] = listing;
                    update(ref(db), updates);
                    const listingRef = ref(db, 'listings/listings/');
                    onValue(listingRef, (snapshot) => {
                      const data = snapshot.val();
                      if(data != null ){
                        let dataLen = data.length;
                        updates['listings/listings/'+dataLen] = listing;
                        update(ref(db), updates);
                      } else {
                        updates['listings/listings/0'] = listing;
                        update(ref(db), updates);
                      }
                    },{
                        onlyOnce: true
                    });
                    
                  } else if(listing.listingType == 'car'){
                    updates['cars/'+listing.listingName] = listing;
                    updates['hosts/hostAccount/'+userId+'/cars/'+listing.listingName] = listing;
                    update(ref(db), updates);
                    const listingRef = ref(db, 'listings/listings/');
                    onValue(listingRef, (snapshot) => {
                      const data = snapshot.val();
                      if(data != null){
                        let dataLen = data.length;
                        updates['listings/listings/'+dataLen] = listing;
                        update(ref(db), updates);
                      } else {
                        updates['listings/listings/0'] = listing;
                        update(ref(db), updates);
                      }
                    },{
                        onlyOnce: true
                    });
                  }
                 }
              });

              const listingRef = ref(db, 'listings/listings/');
              onValue(listingRef, (snapshot) => {
                const data = snapshot.val();
                if(data != null){
                  for(let i = 0; i < data.length; i++){
                let newdata = data[i]; 
                if(newdata != null && newdata.listingImg != 'undefined' && newdata.host === userId){
                  let cardOuter = document.createElement('div');
                  cardOuter.setAttribute('class', 'col-md-6 col-lg-4');
                  cardOuter.style.margin = '1em';
                  cardOuter.setAttribute('id', 'listing'+i);

                  let rcc = document.createElement('div');
                  rcc.setAttribute('class', "rotating-card-container");
                  rcc.style.marginBottom = '30px';

                  let cardInnerInner = document.createElement('div');
                  cardInnerInner.setAttribute('class', 'card card-rotate bg-rose');

                  let cardImg = document.createElement('img');
                  cardImg.setAttribute('src', newdata.listingImg);
                  cardImg.style.width = '300px';

                  let front = document.createElement('div');
                  front.setAttribute('class', 'front');
                  

                  let cardBody = document.createElement('div');
                  cardBody.setAttribute('class', 'card-body');
                  cardBody.style.padding = '3em';


                  let back = document.createElement('h6');
                  back.setAttribute('class', "back");
                  back.innerText = data[i].listingName;
                  back.style.paddingTop = '3em';

                  let cardTitle = document.createElement('h4');
                  cardTitle.setAttribute('class', 'card-body');
                  cardTitle.style.paddingBottom = '3em';
              
                  back.appendChild(cardTitle);
                  cardInnerInner.appendChild(back);
      
                  front.appendChild(cardImg);
                  cardInnerInner.appendChild(front);
                  rcc.appendChild(cardInnerInner);
                  cardOuter.appendChild(rcc);
                  document.getElementById('listings').appendChild(cardOuter);

                  let dltIcn = document.createElement('div');
                  dltIcn.innerHTML = `<i class="medium material-icons dlt">remove_circle</i>`
                  
                  back.appendChild(dltIcn);

                  dltIcn.addEventListener('click', function(){
                    document.getElementById('listing'+i).remove();
                    document.cookie = 'deletedId='+data[i].itemId;
                    remove(ref(db, 'listings/listings/'+i));
                    fetch("https://www.buorgoldengreenresorts.homes/src/host/listings", {
                    method: 'POST',
                    body: ''
                    
                })
                .then((res) => res)
                .then((err) => err);

                  });

                }
              }
                }
            }); 

              //document.getElementById('welcome').innerHTML = 'Welcome '+ userName;            
            } else {
              // User is signed out
            }

          });
       

        </script>
                <!--  Google Maps Plugin    -->
                <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkpJhu166GoiLCkiRzVYLZdb-5DvYGuss&libraries=places&callback=initMap&v=weekly" async></script>
       
      </body>
</html>