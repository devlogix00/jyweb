<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <title>
          BookMe
        </title>
        <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
        <!--     Fonts and icons     -->
        <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
        <!-- CSS Files -->
        <link href="./css/material-kit.css"  rel="stylesheet" />
        <script src="./js/core/jquery.min.js" type="text/javascript"></script>
        <script src="./js/core/popper.min.js" type="text/javascript"></script>
        <script src="./js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
        <script src="./js/plugins/moment.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script async defer src="https://buttons.github.io/buttons.js"></script> 
        
      </head>

      <body class="sidebar-collapse">        
        <!-- <nav class="navbar navbar-color-on-scroll navbar-transparent fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
          <div class="container">
            <div class="navbar-translate" ></div>          
          </div>
        </nav> -->
        <div style="margin: 1em;">
        <div style="display:flex; margin: 1em; justify-content: space-between;">
            <h2 id="welcome"></h2>  
            <div style="margin: 1em; ">
              <i class="material-icons" style="color: #6849da;" onclick="openChat()">mail</i>          
              <i id="signout" onclick="signout()" style="padding: 1em; font-size: 27px;" class="fa fa-sign-out" aria-hidden="true"></i>
            </div>  
        </div>
        <div id="packages">
          <div class="row">
            <div class="col-md-4">
              <div class="card card-blog">
                <div class="card-header card-header-image">
                  <a id="roomdata" href="rooms.html">
                   <img src="./img/69353da4-0c20-44d8-971a-9ffc09898170.jpg" alt="">
                  </a>
                <div class="colored-shadow" style="opacity: 1;"></div></div>
                <div class="card-body">
                  <h6 class="card-category text-warning">Room Only Package</h6>
                  <h4 class="card-title">
                    <a>Book A Room</a>
                  </h4>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-blog">
                <div class="card-header card-header-image">
                  <a id='cardata' href="cars.html">
                    <img src="./img/f622d169-4047-41ca-bb81-e92e227f16c2.jpg" alt="">
                  </a>
                <div class="colored-shadow" style="opacity: 1;"></div></div>
                <div class="card-body">
                  <h6 class="card-category text-rose">Ride Share</h6>
                  <h4 class="card-title">
                    <a>Rent a Car</a>
                  </h4>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card card-blog">
                <div class="card-header card-header-image">
                  <a id='tourdata' href="tourism.html">
                    <img src="./img/Kakum-National-Park.jpg" alt="">
                  </a>
                 <div class="colored-shadow" style="opacity: 1;"></div>
                </div>
                <div class="card-body ">
                  <h6 class="card-category text-info">Tourist Attractions</h6>
                  <h4 class="card-title">
                    <a>Book a Tour</a>
                  </h4>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h2>Your Recent Bookings</h2>
          <div id="bookings"></div>
        </div>
   </div>
        <!-- <div>
            <footer >
                <div class="container">
                  <div class=" float-right">
                    &copy;
                    <script>
                      document.write(new Date().getFullYear())
                    </script>, made with <i class="material-icons" style="color: red; background-color: white;">favorite</i> by
                    <a href="https://www.creative-tim.com" target="_blank">Maame Nyarko</a> 
                  </div>
                </div>
              </footer>
        </div> -->
        <!--   Core JS Files   -->
        
        
        <script src="./js/core/jquery.min.js" type="text/javascript"></script>
        <script src="./js/core/popper.min.js" type="text/javascript"></script>
        <script src="./js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
        <script src="./js/plugins/moment.min.js"></script>
        <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
        <script src="./js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
        <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
        <script src="./js/plugins/nouislider.min.js" type="text/javascript"></script>
        <!--  Google Maps Plugin    -->
        <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY_HERE"></script>
        <!--	Plugin for Tags, full documentation here: https://github.com/bootstrap-tagsinput/bootstrap-tagsinputs  -->
        <script src="./js/plugins/bootstrap-tagsinput.js"></script>
        <!--	Plugin for Select, full documentation here: http://silviomoreto.github.io/bootstrap-select -->
        <script src="./js/plugins/bootstrap-selectpicker.js" type="text/javascript"></script>
        <!--	Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
        <script src="./js/plugins/jasny-bootstrap.min.js" type="text/javascript"></script>
        <!--	Plugin for Small Gallery in Product Page -->
        <script src="./js/plugins/jquery.flexisel.js" type="text/javascript"></script>
        <!-- Plugins for presentation and navigation  -->
        <!-- Place this tag in your head or just before your close body tag. -->
        <script async defer src="https://buttons.github.io/buttons.js"></script>
        <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
        <script src="./js/material-kit.js?v=2.2.0" type="text/javascript"></script>
        <!-- <script src="./init.js"></script> -->
        <script>
          let userId;
          let userName;       
        </script>
        <script type="module">
          // Import the functions you need from the SDKs you need
          import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
          import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
          import { initializeAuth,getAuth, onAuthStateChanged, signOut} from "https://www.gstatic.com/firebasejs/9.6.8/firebase-auth.js";
          import { getDatabase, ref, set, onValue, push, child, orderByChild, update} from "https://www.gstatic.com/firebasejs/9.6.8/firebase-database.js";
          import {getFirestore, collection, addDoc, doc, getDoc, enableIndexedDbPersistence} from "https://www.gstatic.com/firebasejs/9.6.8/firebase-firestore.js";
          // TODO: Add SDKs for Firebase products that you want to use
          // https://firebase.google.com/docs/web/setup#available-libraries
          // Your web app's Firebase configuration
          // For Firebase JS SDK v7.20.0 and later, measurementId is optional
          const firebaseConfig = {
            apiKey: "AIzaSyAN-hSy8cWKUKJS4SxjNcN9lrmvZPTy430",
            authDomain: "booking-app-6750f.firebaseapp.com",
            databaseURL: "https://booking-app-6750f-default-rtdb.firebaseio.com",
            projectId: "booking-app-6750f",
            storageBucket: "booking-app-6750f.appspot.com",
            messagingSenderId: "687482685582",
            appId: "1:687482685582:web:a91f903ce5133c4f5aa1df",
            measurementId: "G-0WDDDKD9ZL"
          };
        
          // Initialize Firebase
          const app = initializeApp(firebaseConfig);
          const analytics = getAnalytics(app);
          const auth = getAuth(); 
          const db = getDatabase(); 
          const database = getFirestore(app);
      

          var today = new Date();
          var dd = String(today.getDate()).padStart(2, '0');
          var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
          var yyyy = today.getFullYear();

          today = mm + '-' + dd + '-' + yyyy;

          
          let status;

          const updates = {};

          onAuthStateChanged(auth, (user) => {
            if (user) {
              // User is signed in 
         
              userName = user.displayName;
              userId = user.uid;
              document.cookie = 'uid='+userId;
     
              document.getElementById('welcome').innerHTML = 'Welcome '+ userName;
              document.getElementById('bookings').style.display = 'flex';
              document.getElementById('bookings').style.flexWrap = 'wrap';
              
              function displayBookedRoom(){
                  const roomdataref = ref(db, 'users/userAccount/'+userId+'/roomdata');
                  onValue(roomdataref, (snapshot) => {
                  const data = snapshot.val();
                  if(data !== null){
                    if(data.roomStatus !== null && data.roomStatus == 'paid'){
                      let roomNm = data.room;
                      updates['rooms/'+roomNm+'/currentUser'] = userId;
                      updates['rooms/'+roomNm+'/bookingDate'] = data.bookingDate;
                      updates['rooms/'+roomNm+'/img'] = data.img;
                      updates['rooms/'+roomNm+'/userName'] = data.userName;
                      updates['rooms/'+roomNm+'/roomDates'] = data.roomDates;
                      update(ref(db), updates);
                      let hrs = data.datesLength * 24;
                      let mll = hrs * 3.6e+6;
                      let cardOuter = document.createElement('div');
                      cardOuter.setAttribute('class', 'col-md-4');
                      cardOuter.setAttribute('id', data.room);
                      let cardOuterInner = document.createElement('div');
                      cardOuterInner.setAttribute('class', "card card-blog");
                      let cardInnerInner = document.createElement('div');
                      cardInnerInner.setAttribute('class', 'card-header card-header-image');
                      let cardImg = document.createElement('img');
                      cardImg.setAttribute('src', data.img);
                      let cardBody = document.createElement('div');
                      cardBody.setAttribute('class', 'card-body');
                      let cardHeader = document.createElement('h6');
                      cardHeader.setAttribute('class', "card-category text-info");
                      cardHeader.innerText = data.room;
                      let cardTitle = document.createElement('h4');
                      cardTitle.setAttribute('class', 'card-title');
                      cardTitle.style.paddingBottom = '3em';
                      if(data.roomDates.length == 1){
                        cardTitle.innerText = data.roomDates[0];
                      } else {
                        cardTitle.innerText = data.roomDates[0]+' - '+data.roomDates[1];
                      }
                      cardBody.appendChild(cardHeader);
                      cardHeader.appendChild(cardTitle);
                      cardInnerInner.appendChild(cardImg);
                      cardInnerInner.appendChild(cardBody);
                      cardOuterInner.appendChild(cardInnerInner);
                      cardOuter.appendChild(cardOuterInner);
                      document.getElementById('bookings').appendChild(cardOuter);

                      cardOuter.addEventListener('click', function(){
          
                        let bookingRef = ref(db, 'rooms/'+roomNm);
                        onValue(bookingRef, (snapshot) => {
                          const data = snapshot.val();
                          let url = data.bookingUrl;
                          window.location = './bookroom.html';
                        })
                      });
                    }
                    }
                  });
                }

                displayBookedRoom();

                function displayBookedCar(){
                    const cardataref = ref(db, 'users/userAccount/'+userId+'/cardata');
                    onValue(cardataref, (snapshot) => {
                    const data = snapshot.val();
                    if(data !== null){
                      if(data.carStatus !== null && data.carStatus == 'paid'){
                        let cardOuter = document.createElement('div');
                        cardOuter.setAttribute('class', 'col-md-4');
                        cardOuter.setAttribute('id', data.car);
                        let cardOuterInner = document.createElement('div');
                        cardOuterInner.setAttribute('class', "card card-blog");
                        let cardInnerInner = document.createElement('div');
                        cardInnerInner.setAttribute('class', 'card-header card-header-image');
                        let cardImg = document.createElement('img');
                        cardImg.setAttribute('src', data.img);
                        let cardBody = document.createElement('div');
                        cardBody.setAttribute('class', 'card-body');
                        let cardHeader = document.createElement('h6');
                        cardHeader.setAttribute('class', "card-category text-info");
                        cardHeader.innerText = data.car;
                        let cardTitle = document.createElement('h4');
                        cardTitle.setAttribute('class', 'card-title');
                        cardTitle.style.paddingBottom = '3em';
                        if(data.carDates.length == 1){
                          cardTitle.innerText = data.carDates[0];
                        } else {
                          cardTitle.innerText = data.carDates[0]+' - '+data.carDates[1];
                        }
                        cardBody.appendChild(cardHeader);
                        cardHeader.appendChild(cardTitle);
                        cardInnerInner.appendChild(cardImg);
                        cardInnerInner.appendChild(cardBody);
                        cardOuterInner.appendChild(cardInnerInner);
                        cardOuter.appendChild(cardOuterInner);
                        document.getElementById('bookings').appendChild(cardOuter);

                        cardOuter.addEventListener('click', function(){
                
                          let crName = data.car;
                          let bookingRef = ref(db, 'cars/'+crName);
                          onValue(bookingRef, (snapshot) => {
                            const data = snapshot.val();
                            let url = data.bookingUrl;
                            window.location = './bookcar.html';
                          })
                        });
                      }
                }
                });
              }

              displayBookedCar();
              
              function displayBookedTour(){
                  const tourdataref = ref(db, 'users/userAccount/'+userId+'/tourdata');
                  onValue(tourdataref, (snapshot) => {
                  const data = snapshot.val();
                  if(data !== null){
                    if(data.tourStatus !== null && data.tourStatus == 'paid'){
                      let hrs = data.datesLength * 24;
                      let mll = hrs * 3.6e+6;
                      let cardOuter = document.createElement('div');
                      cardOuter.setAttribute('class', 'col-md-4');
                      cardOuter.setAttribute('id', data.tour);
                      let cardOuterInner = document.createElement('div');
                      cardOuterInner.setAttribute('class', "card card-blog");
                      let cardInnerInner = document.createElement('div');
                      cardInnerInner.setAttribute('class', 'card-header card-header-image');
                      let cardImg = document.createElement('img');
                      cardImg.setAttribute('src', data.img);
                      let cardBody = document.createElement('div');
                      cardBody.setAttribute('class', 'card-body');
                      let cardHeader = document.createElement('h6');
                      cardHeader.setAttribute('class', "card-category text-info");
                      cardHeader.innerText = data.tour;
                      let cardTitle = document.createElement('h4');
                      cardTitle.setAttribute('class', 'card-title');
                      cardTitle.style.paddingBottom = '3em';
                      if(data.tourDates.length == 1){
                        cardTitle.innerText = data.tourDates[0];
                      } else {
                        cardTitle.innerText = data.tourDates[0]+' - '+data.tourDates[1];
                      }

                      cardBody.appendChild(cardHeader);
                      cardHeader.appendChild(cardTitle);
                      cardInnerInner.appendChild(cardImg);
                      cardInnerInner.appendChild(cardBody);
                      cardOuterInner.appendChild(cardInnerInner);
                      cardOuter.appendChild(cardOuterInner);
                      document.getElementById('bookings').appendChild(cardOuter);

                      cardOuter.addEventListener('click', function(){
                   
                        let trName = data.tour;
                        let bookingRef = ref(db, 'tours/'+trName);
                        onValue(bookingRef, (snapshot) => {
                          const data = snapshot.val();
                          let url = data.bookingUrl;
                          window.location = './booktour.html';
                        })
                      });

                    }
                }
                });
              }

              displayBookedTour();
             
              function displayBookedDriver(){
                  const driverdataref = ref(db, 'users/userAccount/'+userId+'/driverdata');
                  onValue(driverdataref, (snapshot) => {
                  const data = snapshot.val();
                  if(data !== null){
           
                    if(data.driverStatus !== null && data.driverStatus == 'paid'){
                       let cardOuter = document.createElement('div');
                       cardOuter.setAttribute('class', 'col-md-4');
                       cardOuter.setAttribute('id', data.driver);
                       let cardOuterInner = document.createElement('div');
                       cardOuterInner.setAttribute('class', "card card-blog");
                       let cardInnerInner = document.createElement('div');
                       cardInnerInner.setAttribute('class', 'card-header card-header-image');
                       let cardImg = document.createElement('img');
                       cardImg.setAttribute('src', data.img);
                       let cardBody = document.createElement('div');
                       cardBody.setAttribute('class', 'card-body');
                       let cardHeader = document.createElement('h6');
                       cardHeader.setAttribute('class', "card-category text-info");
                       cardHeader.innerText = data.driver;
                       let cardTitle = document.createElement('h4');
                       cardTitle.setAttribute('class', 'card-title');
                       cardTitle.style.paddingBottom = '3em';
                       if(data.driverDates.length == 1){
                        cardTitle.innerText = data.driverDates[0];
                      } else {
                        cardTitle.innerText = data.driverDates[0]+' - '+data.driverDates[1];
                      }

                      cardBody.appendChild(cardHeader);
                      cardHeader.appendChild(cardTitle);
                      cardInnerInner.appendChild(cardImg);
                      cardInnerInner.appendChild(cardBody);
                      cardOuterInner.appendChild(cardInnerInner);
                      cardOuter.appendChild(cardOuterInner);
                      document.getElementById('bookings').appendChild(cardOuter);

                      cardOuter.addEventListener('click', function(){
                        let drName = data.driver;
                        let bookingRef = ref(db, 'bookedDrivers/'+drName);
                        onValue(bookingRef, (snapshot) => {
                          const data = snapshot.val();
                          let url = data.bookingUrl;
                          let splitDt = url.split('/');
                          let serveUrl = splitDt[3];
                          window.location = './bookdriver.html';
                        })
                        
                      });

                    }
                    let bookedDriversRef = ref(db, 'bookedDrivers/'+data.driver+'/userImg');
                    onValue(bookedDriversRef, (snapshot) => {
                      const bkddata = snapshot.val();
                      if(bkddata == null){
                        let updates = {};
                        updates['bookedDrivers/'+data.driver+'/userImg'] = user.photoURL;
                        update(ref(db), updates);
                      }
                    });
                }
                });
                
               
              }

              displayBookedDriver();
               
            } else {
              // User is signed out
  
            }

          });

          

          // const roomData = {
          //   room: '',
          //   dates: ''
          // }

          // const carData = {
          //   car: '',
          //   dates: ''
          // }

          // const tourData = {
          //   tourStop: '',
          //   dates: ''
          // }

          // const roomPostKey = push(child(ref(db), 'users/userAccount/'+userId+'/'+today+'/roomData')).key;
          // const carPostKey = push(child(ref(db), 'users/userAccount/'+userId+'/'+today+'/carData')).key;
          // const tourPostKey = push(child(ref(db), 'users/userAccount/'+userId+'/'+today+'/tourData')).key;

          // const updates = {};

          // const roomLink = document.querySelector('#roomdata');
          // roomLink.addEventListener('click', e => {
            
          // })


          // function writeUserData(userId){
          //   set(ref(db, '/users/'+'userAccount/'+userId+'/'+today), {
              
          //   });
          // }
      
          // writeUserData(userId);

          // const urlParams = new URLSearchParams(window.location.search);  

          

          const signoutBtn = document.querySelector('#signout');
          signoutBtn.addEventListener('click', e => {
            e.preventDefault();
            signOut(auth).then(() => {
                // Sign-out successful
                window.location = "./bookme.html";

              }).catch((error) => {
                // An error happened
              });
          });


        </script> 
        <script>
          function openChat(){
            window.location = "https://bookme-e703b.web.app/";
          }
        </script>
      </body>
</html>